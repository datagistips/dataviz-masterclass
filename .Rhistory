# Flux
flux <<- readRDS("flux.rds") %>% filter(str_detect(idcom, "^(04|05|06|13|83|84)") == "93")
setwd("shinyapp")
flux <<- readRDS("flux.rds") %>% filter(str_detect(idcom, "^(04|05|06|13|83|84)") == "93")
setwd("shinyapp/app1")
setwd("app1")
flux <<- readRDS("flux.rds") %>% filter(str_detect(idcom, "^(04|05|06|13|83|84)") == "93")
library(tidyverse)
flux <<- readRDS("flux.rds") %>% filter(str_detect(idcom, "^(04|05|06|13|83|84)") == "93")
nrow(flux)
?str_detect
flux <<- readRDS("flux.rds") %>% filter(str_detect(idcom, "^(04|05|06|13|83|84)"))
flux
runApp()
runApp()
runApp()
runApp()
readRDS("comms.rds")
runApp()
runApp()
runApp()
coords <- c(5.974598, 44.0858)
pt <- coords %>% st_point %>% st_sfc
pt
pt <- coords %>% st_point %>% st_sfc %>% st_set_crs(4326)
i <- st_intersects(comms, i)
i <- st_intersects(comms, pt)
i
unlist(i)
?st_intersects
sapply(i, function(x) length(i) > 0)
sapply(i, function(x) length(i[[1]]) > 0)
sapply(i, function(x) length(i[[1]]) > 0) %>% which
runApp()
coords <- c(5.96021, 43.56232)
pt <- coords %>% st_point %>% st_sfc %>% st_set_crs(4326)
i <- st_intersects(comms, pt)
which(sapply(i, function(x) length(x) != 0))
runApp()
runApp()
runApp()
runApp()
flux %>% makeStream("13001")
codeInsee <- "13001"
df <- flux %>% getStatsFlux(codeInsee)
df
# L'ordre des inverse dans les streamgraphs
df$type <- factor(df$type, levels = c("Inconnu", "Mixte", "Activité", "Habitat"))
# Plot
df %>%
streamgraph("type", "value", "year", sort = FALSE) %>%
sg_axis_x(1, "Année", "%Y") %>%
sg_fill_manual(rev(palette))
palette
runApp()
runApp()
runApp()
glue("color:{pal['red']}")
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
shiny::runApp('shinyapp/app1')
comms <- st_read("C:/Users/mathieu.rajerison/Documents/DATAS/ADMIN-EXPRESS-COG_2-1__SHP__FRA_L93_2020-03-25/ADMIN-EXPRESS-COG_2-1__SHP__FRA_2020-03-25/ADMIN-EXPRESS-COG/1_DONNEES_LIVRAISON_2020-03-25/ADE-COG_2-1_SHP_LAMB93_FR/COMMUNE_CARTO.shp") %>% st_set_crs(2154) %>% st_transform(4326)
library(sf)
library(tidyverse)
comms <- st_read("C:/Users/mathieu.rajerison/Documents/DATAS/ADMIN-EXPRESS-COG_2-1__SHP__FRA_L93_2020-03-25/ADMIN-EXPRESS-COG_2-1__SHP__FRA_2020-03-25/ADMIN-EXPRESS-COG/1_DONNEES_LIVRAISON_2020-03-25/ADE-COG_2-1_SHP_LAMB93_FR/COMMUNE_CARTO.shp") %>% st_set_crs(2154) %>% st_transform(4326)
st_coordinates(comms %>% filter(INSEE_COM == "13001"))
st_coordinates(comms %>% filter(INSEE_COM == "13001") %>% st_centroid)
pt <- c(5.398602, 43.53609) %>% st_point %>% st_sfc %>% st_set_crs(4326)
i <- st_intersects(comms, pt)
w <- which(sapply(i, function(x) length(x) != 0))
codeInsee <- comms$INSEE_COM[w]
codeInsee
getCommCenter <- function(comms, coords) {
pt <- coords %>% st_point %>% st_sfc %>% st_set_crs(4326)
i <- st_intersects(comms, pt)
w <- which(sapply(i, function(x) length(x) != 0))
codeInsee <- comms$INSEE_COM[w]
return(codeInsee)
}
comms %>% getCommCenter(c(5.398602, 43.53609))
shiny::runApp('shinyapp-old/app1')
runApp('shinyapp-old/app1')
runApp('shinyapp-old/app1')
runApp('shinyapp-old/app1')
runApp('shinyapp-old/app1')
runApp('shinyapp-old/app1')
runApp('shinyapp-old/app1')
runApp('shinyapp-old/app1')
palette$bleu
palette_cerema$bleu
paletteCerema$bleu
paletteCerema <- fromJSON(file = "palette_cerema.json")
runApp('shinyapp-old/app1')
setwd("shinyapp-old")
setwd("app1")
paletteCerema <- fromJSON(file = "palette_cerema.json")
paletteCerema$secondaire$bleu
palettCerema
paletteCerema
runApp()
paletteCerema
runApp()
paletteCerema
formatC(1000, big.mark=" ")  # 1,001
formatC(1024, big.mark=" ")  # 1,001
runApp()
format(as.numeric(1000876576655), nsmall=1, big.mark=",")  # 1,000.6
format(as.numeric(1000876576655), nsmall=1, big.mark=",", scientific = FALSE)  # 1,000.6
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp('C:/Users/mathieu.rajerison/Desktop/TAFF_MAISON/B_REUNIONS/2111-ATELIER-DATAVIZ/shinyapp')
rm(list=ls())
runApp('C:/Users/mathieu.rajerison/Desktop/TAFF_MAISON/B_REUNIONS/2111-ATELIER-DATAVIZ/shinyapp')
rm(list=ls())
runApp('C:/Users/mathieu.rajerison/Desktop/TAFF_MAISON/B_REUNIONS/2111-ATELIER-DATAVIZ/shinyapp')
runApp('C:/Users/mathieu.rajerison/Desktop/TAFF_MAISON/B_REUNIONS/2111-ATELIER-DATAVIZ/shinyapp')
runApp('C:/Users/mathieu.rajerison/Desktop/TAFF_MAISON/B_REUNIONS/2111-ATELIER-DATAVIZ/shinyapp')
runApp('C:/Users/mathieu.rajerison/Desktop/TAFF_MAISON/B_REUNIONS/2111-ATELIER-DATAVIZ/shinyapp')
comms <- st_read("../data/COMMUNE_CARTO.shp") %>% st_set_crs(2154) %>% st_transform(4326)
library(sf)
library(tidyverse)
comms <- st_read("../data/COMMUNE_CARTO.shp") %>% st_set_crs(2154) %>% st_transform(4326)
comms <- readRDS("notebook/comms.rds")
saveRDS(comms %>% filter(INSEE_REG == 93), "../data/comms.rds")
saveRDS(comms %>% filter(INSEE_REG == 93), "data/comms.rds")
shiny::runApp('shinyapp')
flux <- read_csv("../data/obs_artif_conso_com_2009_2020_V2.csv")
library(tidyverse)
flux <- read_csv("../data/obs_artif_conso_com_2009_2020_V2.csv")
glimpse(flux)
library(tidyverse)
flux <- read_csv("../data/obs_artif_conso_com_2009_2020_V2.csv")
glimpse(flux)
class(flux$surfcom20)
sapply(names(flux), function(x) class(flux[[x]]) == "character") %>% which %>% {names(flux)[.]}
w <- grep("^(-|[0-9]|\\.)*$", flux$artcom0920, perl = TRUE)
flux$artcom0920[-w] %>% unique
w <- grep("^(-|[0-9]|\\.)*$", flux$artpop1217, perl = TRUE)
flux$artpop1217[-w] %>% unique
w <- grep("^(-|[0-9]|\\.)*$", flux$surfcom20, perl = TRUE)
flux$surfcom20[-w] %>% unique
flux$iddep[-w]
flux <- read_csv("../data/obs_artif_conso_com_2009_2020_V2.csv", na = c("", "NULL"))
glimpse(flux)
which(flux$surfcom20 == "NULL")
saveRDS(flux, "../shinyapp-old/app1/flux.rds")
library(tidyverse)
library(tidyverse)
flux <- read_csv("../data/obs_artif_conso_com_2009_2020_V2.csv")
source("helpers.R", encoding = "UTF-8")
df <- flux %>% getStatsFlux("13001")
library(ggplot2)
p <- ggplot(data = df,
aes(x = year,
y = value,
fill = type)) +
geom_bar(stat = "identity")
p
# Ordre des types
df$type <- as.character(df$type)
df$type <- factor(df$type, levels = c("Habitat", "Activité", "Mixte", "Inconnu"))
# Plot
p <- ggplot(data = df,
aes(x = year,
y = value,
fill = type)) +
geom_bar(stat = "identity") +
theme(
axis.title.x = element_blank(),
axis.ticks.x = element_blank(),
axis.text.x = element_text(vjust = 3),
axis.ticks.y = element_blank(),
axis.title.y = element_blank(),
panel.border = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
legend.position = "bottom",
legend.title = element_blank(),
plot.title = element_text(face = "bold", size = 10, colour = "grey60"),
legend.text = element_text(size = 8)
) +
ggtitle("Flux d'artificialisation par année en Ha") +
scale_y_continuous(name = "Ha", expand = c(0, 0))
p
library(colorspace)
colorBlue    <- hcl(h = 220,
c = 50,
l = 80, fixup = TRUE)
colorRed     <- hcl(h = 4,
c = 50,
l = 80, fixup = TRUE)
colorMagenta <- hcl(h = 300,
c = 50,
l = 80, fixup = TRUE)
colorGrey    <- hcl(h = 0,
c = 0,
l = 80, fixup = TRUE)
myPalette <- c("blue" = colorBlue,
"red" = colorRed,
"magenta" = colorMagenta,
"grey" = colorGrey)
demoplot(myPalette, "bar")
hclplot(myPalette)
p +
scale_fill_manual(
name = "Flux\nd'artificialisation\n2009-2020",
labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
values = as.character(myPalette)
)
saveRDS(myPalette, "myPalette.rds")
p + scale_fill_manual(
name = "Flux\nd'artificialisation\n2009-2020",
labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
values = c(colorBlue,
colorRed,
hcl(h = 300, c = 100, l = 80), # Magenta
colorGrey)
)
library(rjson)
paletteCerema <- fromJSON(file = "palette_cerema.json")
library(rjson)
paletteCerema <- fromJSON(file = "palette_cerema.json")
paletteCerema
p + scale_fill_manual(
name = "Flux\nd'artificialisation\n2009-2020",
labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
values = c(paletteCerema$principale$bleu,
paletteCerema$principale$orange,
paletteCerema$principale$vert,
colorGrey)
)
p + scale_fill_manual(
name = "Flux\nd'artificialisation\n2009-2020",
labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
values = c(paletteCerema$secondaire$bleu,
paletteCerema$secondaire$orange,
paletteCerema$secondaire$vert,
colorGrey)
)
p + scale_fill_manual(
name = "Flux\nd'artificialisation\n2009-2020",
labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
values = c(paletteCerema$complementaire$bleu,
paletteCerema$complementaire$orange,
paletteCerema$complementaire$vert,
colorGrey)
)
p + scale_fill_manual(
name = "Flux\nd'artificialisation\n2009-2020",
labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
values = c(paletteCerema$secondaire$bleu,
paletteCerema$secondaire$orange,
paletteCerema$secondaire$vert,
colorGrey)
)
hclcolorpicker()
hclcolorpicker
hclcolorpicker
hclcolorpicker
hclcolorpicker
library(tidyverse)
library(sf)
comms <- st_read("../data/COMMUNE_CARTO.shp") %>%
st_set_crs(2154) %>%
st_transform(4326)
comms <- st_read("../data/COMMUNE_CARTO/COMMUNE_CARTO.shp") %>%
st_set_crs(2154) %>%
st_transform(4326)
![](files/data-eng2.png)
setwd("shinyapp")
shiny::runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
runApp('shinyapp')
l <- list.files("notebooks/files/shinyapp/")
l
l <- list.files("notebooks/files/shinyapp/", full.names = T)
l
l <- list.files("*.png", "notebooks/files/shinyapp/", full.names = T)
l
l <- list.files("notebooks/files/shinyapp/", "*.png", full.names = T)
l
paste(l, collapse=" ")
l2 <- paste(l, collapse=" ")
runApp('shinyapp')
l
n <- gsub("^[0-9]+-.*", "\\1", l)
n*
n
n <- gsub(".*/^[0-9]+-.*", "\\1", l)
n
gsub("^.*/[0-9]+-.*", "\\1", l)
gsub("^.*/([0-9]+)-.*", "\\1", l)
n <- gsub("^.*/([0-9]+)-.*", "\\1", l) %>% as.numeric
n <- gsub("^.*/([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l2
# C:\ImageMagick-7.1.0-Q16-HDRI\magick.exe -delay 100 -loop 0 *.png -morph 10 myimage.gif
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay 50 -loop 0 %s -morph 1 animation.gif", l3)
l3 <- paste(l2, collapse=" ")
l <- list.files("notebooks/files/shinyapp/", "*.png", full.names = T)
n <- gsub("^.*/([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l3 <- paste(l2, collapse=" ")
# C:\ImageMagick-7.1.0-Q16-HDRI\magick.exe -delay 100 -loop 0 *.png -morph 10 myimage.gif
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay 50 -loop 0 %s -morph 1 animation.gif", l3)
cmd
l <- list.files("notebooks/files/shinyapp/", "*.png")
n <- gsub("^.*/([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l3 <- paste(l2, collapse=" ")
# C:\ImageMagick-7.1.0-Q16-HDRI\magick.exe -delay 100 -loop 0 *.png -morph 10 myimage.gif
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay 50 -loop 0 %s -morph 1 animation.gif", l3)
cmd
system(cmd)
setwd("notebooks/files/shinyapp/")
system(cmd)
l2
l <- list.files("notebooks/files/shinyapp/", "*.png")
n <- gsub("^.*/([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l3 <- paste(l2, collapse=" ")
l2
l <- list.files("notebooks/files/shinyapp/", "*.png")
n <- gsub("^.*/([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l2
l <- list.files("notebooks/files/shinyapp/", "*.png")
n <- gsub("^([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l2
l
l <- list.files("notebooks/files/shinyapp/", "*.png")
l
setwd("../..")
l <- list.files("notebooks/files/shinyapp/", "*.png")
l
getwd()
setwd("..")
setwd("..")
getwd()
setwd("shiny-artif")
l <- list.files("notebooks/files/shinyapp/", "*.png")
n <- gsub("^([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l3 <- paste(l2, collapse=" ")
l2
# C:\ImageMagick-7.1.0-Q16-HDRI\magick.exe -delay 100 -loop 0 *.png -morph 10 myimage.gif
# changer le delay
delay <- 50
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d -loop 0 %s -morph 1 animation.gif", delay, l3)
setwd("notebooks/files/shinyapp/")
system(cmd)
l2
l3 <- l[c(17, 18)]
l4 <- paste(l2, collapse=" ")
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d -loop 0 %s -morph 1 animation.gif", delay, l3)
system(cmd)
l4
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d -loop 0 %s -morph 1 animation.gif", delay, l4)
system(cmd)
l4
l4
l4 <- paste(l3, collapse=" ")
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d -loop 0 %s -morph 1 animation.gif", delay, l4)
system(cmd)
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d %s -morph 1 animation.gif", delay, l4)
system(cmd)
l3 <- l2[-c(17, 18)]
l4 <- paste(l3, collapse=" ")
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d %s -morph 1 animation.gif", delay, l4)
system(cmd)
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d %s -morph 3 animation.gif", delay, l4)
system(cmd)
l <- list.files("notebooks/files/shinyapp/", "*.png")
n <- gsub("^([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l3 <- l2[-c(13, 17, 18)]
l4 <- paste(l3, collapse=" ")
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -resize 200x200 -delay %d %s -morph 3 animation.gif", delay, l4)
system(cmd)
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d -resize 200x200 %s -morph 3 animation.gif", delay, l4)
system(cmd)
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d -resize 200x200 %s -morph 3 animation.gif", delay, l4)
system(cmd)
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d %s -morph 3 animation.gif", delay, l4)
system(cmd)
l4
setwd("..")
getwd()
setwd("../..")
getwd()
l <- list.files("notebooks/files/shinyapp/", "*.png")
n <- gsub("^([0-9]+)-.*", "\\1", l) %>% as.numeric
o <- order(n)
l2 <- l[o]
l3 <- l2[-c(13, 17, 18)]
l4 <- paste(l3, collapse=" ")
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d -resize 500x500 %s -morph 1 animation.gif", delay, l4)
system(cmd)
lk4
l4
# GIF
setwd("notebooks/files/shinyapp/")
delay <- 50
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d -resize 500x500 %s -morph 1 animation.gif", delay, l4)
system(cmd)
l4
getwd()
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d %s -morph 1 animation.gif", delay, l4)
system(cmd)
cmd <- sprintf("C:\\ImageMagick-7.1.0-Q16-HDRI\\magick.exe -delay %d %s -morph 1 -loop 0 animation.gif", delay, l4)
system(cmd)
# Compress
cmd <- "C:\\gifsicle-1.92-win64\\gifsicle-1.92 -O3 --lossy=80 --scale 0.8 animation.gif -o animation-compressed.gif"
system(cmd)
runApp('C:/Users/mathieu.rajerison/Desktop/temp/app')
runApp('C:/Users/mathieu.rajerison/Desktop/TAFF_MAISON/GIT/shiny-artif/shinyapp')
runApp('C:/Users/mathieu.rajerison/Desktop/temp/app')
runApp('C:/Users/mathieu.rajerison/Desktop/TAFF_MAISON/GIT/shiny-artif/shinyapp')
rm(list=ls())
shiny::runApp('shinyapp')
library(tidyverse)
flux <- read_csv("../data/obs_artif_conso_com_2009_2020_V2.csv")
myCols <-  names(flux)[grep("^art[0-9]{2}\\S+[0-9]{2}$", names(flux))]
myCols
library(knitr)
df <- flux %>% filter(idcom == "13001")
df[, myCols]
library(knitr)
df <- df[, c("idcom", "idcomtxt", myCols)]
df <- gather(df,
"variable", # key
"value",    # value
myCols) # variables
df
unique(df$variable)
df$year <- gsub("art([0-9]{2})(\\S+)[0-9]{2}", "20\\1", df$variable)
df$type <- gsub("art([0-9]{2})(\\S+)[0-9]{2}", "\\2", df$variable)
df <- df %>% mutate(type = case_when(
type == "hab" ~ "Habitat",
type == "act" ~ "Activité",
type == "mix" ~ "Mixte",
type == "inc" ~ "Inconnu",
))
df$variable <- NULL
getStatsFlux <- function(flux, codeInsee) {
# Filtre par commune
df <- flux %>% filter(idcom == codeInsee)
# Colonnes intéressantes
myCols <-  names(flux)[grep("^art[0-9]{2}\\S+[0-9]{2}$", names(flux))]
df <- df[, c("idcom", "idcomtxt", myCols)]
# Long format
df <- df %>% gather("variable", # key
"value",    # value
myCols) # variables
# Année et type
df$year <- gsub("art([0-9]{2})(\\S+)[0-9]{2}", "20\\1", df$variable)
df$type <- gsub("art([0-9]{2})(\\S+)[0-9]{2}", "\\2", df$variable)
# Renomme les valeurs de type
df <- df %>% mutate(type = case_when(
type == "hab" ~ "Habitat",
type == "act" ~ "Activité",
type == "mix" ~ "Mixte",
type == "inc" ~ "Inconnu"))
# Réagence les colonnes
df <- df[, c("idcom", "idcomtxt", "year", "type", "value")]
return(df)
}
flux %>% getStatsFlux("13001")
library(knitr)
df <- flux %>% filter(idcom == "13001")
df[, c(idcom, myCols)]
library(knitr)
df <- flux %>% filter(idcom == "13001")
df[, c("idcom", myCols)]
library(knitr)
df <- flux %>% filter(idcom == "13001")
df[, c("idcom", "idcomtxt", myCols)]
df
devtools::install_github("hrbrmstr/streamgraph")
