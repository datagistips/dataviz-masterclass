---
title: 'Dataviz Notebook #2'
output:
  html_document:
    df_print: paged
---
# Préparation des données de flux

Lisons les données de flux
```{r}
library(tidyverse)

flux <- read_csv("../data/obs_artif_conso_com_2009_2020_V2.csv")
```

Nous nous intéressons aux flux entre années et allons sélectionner seulement les colonnes utiles, à savoir, les colonnes art09mix10, art10mix11, etc...
```{r}
myCols <-  names(flux)[grep("^art[0-9]{2}\\S+[0-9]{2}$", names(flux))]
myCols
```

Nous utiliserons ggplot2 pour représenter les données. Celui-ci accepte des données au format long et non wide.

Prenons l'exemple d'Aix en Provence :
```{r}
library(knitr)

df <- flux %>% filter(idcom == "13001")
df[, myCols]

```

Pour transformer au format long, nous utilisons la fonction `gather` :
```{r}
library(knitr)
df <- df[, c("idcom", "idcomtxt", myCols)]
df <- gather(df,
             "variable", # key
             "value",    # value
             myCols) # variables
df
```

La colonne `variable` comporte des valeurs telles que art09hab10 pour le flux d'artificialisation vers l'habitat de 2009 à 2010 :
```{r}
unique(df$variable)
```

Nous allons extraire l'année et le type (habitat, activité, mixte, inconnu) depuis le champ ` variable` :
```{r}
df$year <- gsub("art([0-9]{2})(\\S+)[0-9]{2}", "20\\1", df$variable)
df$type <- gsub("art([0-9]{2})(\\S+)[0-9]{2}", "\\2", df$variable)
```

Améliorons le champ type pour avoir des libellés plus parlants :
```{r}
df <- df %>% mutate(type = case_when(
  type == "hab" ~ "Habitat",
  type == "act" ~ "Activité",
  type == "mix" ~ "Mixte",
  type == "inc" ~ "Inconnu",
))
```

Au final, nous n'avons plus besoin de la variable variable :
```{r}
df$variable <- NULL
```

Créons une fonction qui retourne les flux pour une commune :
```{r}
getStatsFlux <- function(flux, codeInsee) {
  
  # Filtre par commune
  df <- flux %>% filter(idcom == codeInsee) 
  
  # Colonnes intéressantes
  myCols <-  names(flux)[grep("^art[0-9]{2}\\S+[0-9]{2}$", names(flux))]
  df <- df[, c("idcom", "idcomtxt", myCols)]
  
  # Long format
  df <- df %>% gather("variable", # key
                      "value",    # value
                      myCols) # variables
  
  # Année et type
  df$year <- gsub("art([0-9]{2})(\\S+)[0-9]{2}", "20\\1", df$variable)
  df$type <- gsub("art([0-9]{2})(\\S+)[0-9]{2}", "\\2", df$variable)
  
  # Renomme les valeurs de type
  df <- df %>% mutate(type = case_when(
  type == "hab" ~ "Habitat",
  type == "act" ~ "Activité",
  type == "mix" ~ "Mixte",
  type == "inc" ~ "Inconnu"))
  
  # Réagence les colonnes
  df <- df[, c("idcom", "idcomtxt", "year", "type", "value")]
  
  return(df)
}

flux %>% getStatsFlux("13001")
```

Enregistrons cette fonction dans le fichier `helpers.R`